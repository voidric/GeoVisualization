// 数据处理与曲面生成
function createTerrainMesh(demData, width, height, exaggeration) {
    // 获取高程极值用于归一化
    let min = Infinity, max = -Infinity;
    for (let i = 0; i < demData.length; i++) {
        if (demData[i] < min) min = demData[i];
        if (demData[i] > max) max = demData[i];
    }

    // 创建平面几何体
    const geometry = new THREE.PlaneGeometry(width, height, width - 1, height - 1);
    const vertices = geometry.attributes.position.array;
    const colors = [];

    // 遍历顶点修改高度
    for (let i = 0, j = 0; i < vertices.length; i += 3, j++) {
        const zVal = demData[j];
        
        // 应用垂直夸张系数实现地形起伏
        vertices[i + 2] = zVal * exaggeration; 

        // 颜色映射方法
        const t = (zVal - min) / (max - min);
        const c = new THREE.Color().setHSL((1.0 - t) * 0.7, 1.0, 0.5);
        colors.push(c.r, c.g, c.b);
    }
    // 重新计算顶点法线
    geometry.computeVertexNormals(); 
    // 设置顶点颜色属性
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

    // 实现基于物理的渲染
    const material = new THREE.MeshStandardMaterial({ 
        vertexColors: true, 
        side: THREE.DoubleSide, 
        roughness: 0.8,
        metalness: 0.2
    });

    return new THREE.Mesh(geometry, material);
}

// 基础交互功能与显示效果
function updateTerrainInteraction(mesh, originalData, newScale, newScheme) {
    const positions = mesh.geometry.attributes.position.array;
    const colors = mesh.geometry.attributes.color.array;
    const { min, max } = getMinMax(originalData);

    // 动态调节夸张度
    for(let i=0, j=0; i < positions.length; i+=3, j++) {
        positions[i+2] = originalData[j] * newScale;
        
        // 动态更新颜色映射
        if (newScheme) {
            const t = (originalData[j] - min) / (max - min);
            const c = getSchemeColor(newScheme, t);
            colors[i] = c.r; colors[i+1] = c.g; colors[i+2] = c.b;
        }
    }
    
    // 标记更新并重算法线
    mesh.geometry.attributes.position.needsUpdate = true;
    mesh.geometry.attributes.color.needsUpdate = true;
    mesh.geometry.computeVertexNormals();
}
